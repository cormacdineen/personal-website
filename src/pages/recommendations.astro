---
import Footer from "@/components/Footer.astro";
import Header from "@/components/Header.astro";
import { SITE } from "@/consts";
import recommendations from "@/data/recommendations.json";
import Layout from "@/layouts/Layout.astro";

const categories = [
  "all",
  "book",
  "podcast",
  "movie",
  "tv",
  "sport",
  "food",
  "experience",
] as const;

const categoryLabels: Record<string, string> = {
  all: "All",
  book: "Books",
  podcast: "Podcasts",
  movie: "Film",
  tv: "TV",
  sport: "Live Sport",
  food: "Food",
  experience: "Experiences",
};

// Collect all unique tags from the data
const allTags = [...new Set(recommendations.flatMap((item) => item.tags || []))].sort();
---

<Layout title={`Cultural stew | ${SITE.title}`} description="Books, podcasts, films, TV, sport, and food recommended by Cormac Dineen.">
  <Header />
  <main id="main-content" class="mx-auto w-full max-w-3xl px-4 pb-12">
    <h1 class="text-2xl font-semibold sm:text-3xl mt-8">Cultural stew</h1>
    <p class="mt-2 mb-6 italic">Everything is ranked out of 10 on the Cormyscale. For calibration, unintentionally ordering a red or white pizza is a 0.2 experience on the Cormyscale and winning big on scratchcard is a 9.8.</p>

    <!-- Category filter tabs -->
    <div class="flex gap-2 mb-4 flex-wrap">
      {categories.map((cat) => (
        <button
          class:list={[
            "filter-btn px-4 py-1.5 rounded-full text-sm font-medium border transition-colors cursor-pointer",
            cat === "all"
              ? "bg-accent text-white border-accent"
              : "bg-transparent text-foreground border-border hover:border-accent",
          ]}
          data-filter={cat}
        >
          {categoryLabels[cat]}
        </button>
      ))}
    </div>

    <!-- Tag filter — collapsible drawer -->
    {allTags.length > 0 && (
      <div class="mb-6">
        <button id="tag-filter-toggle" class="px-4 py-1.5 rounded-full text-sm font-medium border border-border text-foreground/70 bg-transparent hover:border-accent hover:text-accent cursor-pointer transition-colors">
          Filter
        </button>
        <div id="tag-filter-drawer" class="hidden mt-3">
          <div class="flex gap-1.5 flex-wrap items-center">
            <span class="text-xs text-foreground/50 mr-1">Tags:</span>
            {allTags.map((tag) => (
              <button class="tag-btn px-2.5 py-0.5 rounded-full text-xs border border-border text-foreground/70 bg-transparent hover:border-accent hover:text-accent cursor-pointer transition-colors" data-tag={tag}>{tag}</button>
            ))}
          </div>
        </div>
      </div>
    )}

    <!-- Grid of cards -->
    <div id="rec-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {recommendations.map((item) => {
        const rating = (item as any).rating as number | undefined;
        const dateStr = (item as any).date as string | undefined;
        const formattedDate = dateStr ? new Date(dateStr + "-01").toLocaleDateString("en-GB", { month: "short", year: "numeric" }) : "";
        return (
        <div
          class="rec-card border border-border rounded-lg overflow-hidden"
          data-type={item.type}
          data-tags={(item.tags || []).join(",")}
        >
          <div class="relative">
            {item.cover ? (
              <img
                src={item.cover}
                alt={item.title}
                class="w-full h-64 object-cover"
                loading="lazy"
              />
            ) : (
              <div class="w-full h-64 bg-gradient-to-br from-accent/20 via-accent/10 to-background flex items-center justify-center p-6">
                <span class="text-2xl font-bold text-accent/80 text-center leading-tight">{item.title}</span>
              </div>
            )}
            {rating && (
              <div class="absolute top-2 right-2 bg-background/80 backdrop-blur-sm rounded-lg px-2.5 py-1.5">
                <span class="text-2xl font-bold text-accent">{rating}</span>
                <span class="text-[10px] text-foreground/50 ml-0.5 block text-center">Cormyscale</span>
              </div>
            )}
          </div>
          <div class="p-3">
            <span class="text-xs uppercase tracking-wide text-accent font-medium">{item.type}</span>
            <h3 class="font-semibold mt-1">{item.title}</h3>
            <p class="text-sm text-foreground/60">{item.creator}</p>
            {formattedDate && <p class="text-xs text-foreground/40 mt-0.5">{formattedDate}</p>}
            <p class="text-sm mt-2">{item.note}</p>
            {item.tags && item.tags.length > 0 && (
              <div class="flex gap-1 mt-2 flex-wrap">
                {item.tags.map((tag: string) => (
                  <span class="text-[10px] px-1.5 py-0.5 rounded-full bg-muted text-foreground/60">{tag}</span>
                ))}
              </div>
            )}
          </div>
        </div>
        );
      })}
    </div>
  </main>
  <Footer />
</Layout>

<script is:inline>
  document.addEventListener("astro:page-load", () => {
    const categoryButtons = document.querySelectorAll(".filter-btn");
    const tagButtons = document.querySelectorAll(".tag-btn");
    const cards = document.querySelectorAll(".rec-card");

    let activeCategory = "all";
    let activeTag = null;

    function applyFilters() {
      cards.forEach((card) => {
        const cardType = card.dataset.type;
        const cardTags = card.dataset.tags ? card.dataset.tags.split(",") : [];

        const matchesCategory = activeCategory === "all" || cardType === activeCategory;
        const matchesTags = !activeTag || cardTags.includes(activeTag);

        card.style.display = matchesCategory && matchesTags ? "" : "none";
      });
    }

    // Category filter — mutually exclusive
    categoryButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        activeCategory = btn.dataset.filter;

        categoryButtons.forEach((b) => {
          b.classList.remove("bg-accent", "text-white", "border-accent");
          b.classList.add("bg-transparent", "text-foreground", "border-border");
        });
        btn.classList.add("bg-accent", "text-white", "border-accent");
        btn.classList.remove("bg-transparent", "text-foreground", "border-border");

        applyFilters();
      });
    });

    // Tag filter drawer toggle
    const tagFilterToggle = document.getElementById("tag-filter-toggle");
    const tagFilterDrawer = document.getElementById("tag-filter-drawer");
    if (tagFilterToggle && tagFilterDrawer) {
      tagFilterToggle.addEventListener("click", () => {
        tagFilterDrawer.classList.toggle("hidden");
        const isOpen = !tagFilterDrawer.classList.contains("hidden");
        tagFilterToggle.textContent = isOpen ? "Hide filters" : "Filter";
        if (isOpen) {
          tagFilterToggle.classList.add("bg-accent", "text-white", "border-accent");
          tagFilterToggle.classList.remove("text-foreground/70", "border-border");
        } else {
          tagFilterToggle.classList.remove("bg-accent", "text-white", "border-accent");
          tagFilterToggle.classList.add("text-foreground/70", "border-border");
        }
      });
    }

    // Tag filter — single-select
    tagButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tag = btn.dataset.tag;
        tagButtons.forEach((b) => {
          b.classList.remove("bg-accent", "text-white", "border-accent");
          b.classList.add("border-border", "text-foreground/70");
        });
        if (activeTag === tag) {
          activeTag = null;
        } else {
          activeTag = tag;
          btn.classList.add("bg-accent", "text-white", "border-accent");
          btn.classList.remove("border-border", "text-foreground/70");
        }
        applyFilters();
      });
    });
  });
</script>
